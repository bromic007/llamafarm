name: Build and Push Docker Images

# This workflow handles Docker image building with different strategies:
# - For PRs: Build images and save as artifacts (no registry push)
# - For branches/tags: Build and push to registry, create multi-arch manifests
# - PR artifacts are used by create-manifest and test-compose jobs for validation

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build AMD64 images on standard Ubuntu runners
  build-amd64:
    name: Build AMD64 Docker Images
    runs-on: ${{ matrix.service == 'runner' && 'lf-large-amd64' || 'ubuntu-latest' }}
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [designer, server, rag, runtime]
        include:
          - service: designer
            context: ./designer
            dockerfile: ./designer/Dockerfile
            description: 'LlamaFarm Designer - React frontend with nginx'
          - service: server
            context: ./
            dockerfile: ./server/Dockerfile
            description: 'LlamaFarm Server - FastAPI backend'
          - service: rag
            context: ./
            dockerfile: ./rag/Dockerfile
            description: 'LlamaFarm RAG - Celery worker for RAG processing'
          - service: runtime
            context: ./
            dockerfile: ./runtimes/universal/Dockerfile
            description: 'LlamaFarm Universal Runtime - Universal Runtime for all models'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space for large images
        if: matrix.service == 'runtime'
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove large unnecessary packages to free up ~10GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo apt-get clean

          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch,suffix=-amd64
            type=ref,event=pr,suffix=-amd64
            type=semver,pattern={{version}},suffix=-amd64
            type=semver,pattern={{major}}.{{minor}},suffix=-amd64
            type=semver,pattern={{major}},suffix=-amd64
            type=sha,prefix=${{ github.ref_name }}-,suffix=-amd64
            type=raw,value=latest-amd64,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=LlamaFarm ${{ matrix.service }}
            org.opencontainers.image.description=${{ matrix.description }}
            org.opencontainers.image.vendor=LlamaFarm

      - name: Build and push AMD64 Docker image
        id: build
        uses: docker/build-push-action@v5
        timeout-minutes: 60
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}-amd64
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-amd64
          outputs: ${{ github.event_name == 'pull_request' && format('type=docker,dest={0}/{1}-amd64.tar', runner.temp, matrix.service) || '' }}
          build-args: |
            GIT_SHA=${{ github.sha }}

      - name: Upload AMD64 image artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-amd64-image
          path: ${{ runner.temp }}/${{ matrix.service }}-amd64.tar
          retention-days: 1

  # Build ARM64 images on native ARM64 runners for efficiency
  build-arm64:
    name: Build ARM64 Docker Images
    runs-on: ${{ matrix.service == 'runner' && 'lf-large-arm64' || 'ubuntu-24.04-arm' }}
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [designer, server, rag, runtime]
        include:
          - service: designer
            context: ./designer
            dockerfile: ./designer/Dockerfile
            description: 'LlamaFarm Designer - React frontend with nginx'
          - service: server
            context: ./
            dockerfile: ./server/Dockerfile
            description: 'LlamaFarm Server - FastAPI backend'
          - service: rag
            context: ./
            dockerfile: ./rag/Dockerfile
            description: 'LlamaFarm RAG - Celery worker for RAG processing'
          - service: runtime
            context: ./
            dockerfile: ./runtimes/universal/Dockerfile
            description: 'LlamaFarm Universal Runtime - Universal Runtime for all models'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space for large images
        if: matrix.service == 'runtime'
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove large unnecessary packages to free up ~10GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo apt-get clean

          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch,suffix=-arm64
            type=ref,event=pr,suffix=-arm64
            type=semver,pattern={{version}},suffix=-arm64
            type=semver,pattern={{major}}.{{minor}},suffix=-arm64
            type=semver,pattern={{major}},suffix=-arm64
            type=sha,prefix=${{ github.ref_name }}-,suffix=-arm64
            type=raw,value=latest-arm64,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=LlamaFarm ${{ matrix.service }}
            org.opencontainers.image.description=${{ matrix.description }}
            org.opencontainers.image.vendor=LlamaFarm

      - name: Build and push ARM64 Docker image
        id: build
        uses: docker/build-push-action@v5
        timeout-minutes: 60
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}-arm64
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-arm64
          outputs: ${{ github.event_name == 'pull_request' && format('type=docker,dest={0}/{1}-arm64.tar', runner.temp, matrix.service) || '' }}
          build-args: |
            GIT_SHA=${{ github.sha }}

      - name: Upload ARM64 image artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-arm64-image
          path: ${{ runner.temp }}/${{ matrix.service }}-arm64.tar
          retention-days: 1

  # Create multi-arch manifests combining AMD64 and ARM64 images
  create-manifest:
    name: Create Multi-Arch Manifests
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [designer, server, rag]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download AMD64 image artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-amd64-image
          path: ${{ runner.temp }}

      - name: Download ARM64 image artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-arm64-image
          path: ${{ runner.temp }}

      - name: Load images from artifacts (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "Loading images from artifacts for PR validation"
          docker load -i ${{ runner.temp }}/${{ matrix.service }}-amd64.tar
          docker load -i ${{ runner.temp }}/${{ matrix.service }}-arm64.tar

          # List loaded images for verification
          echo "Loaded images:"
          docker images | grep ${{ matrix.service }}

      - name: Extract metadata for multi-arch tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=${{ github.ref_name }}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create and push multi-arch manifest (branches/tags)
        if: github.event_name != 'pull_request'
        run: |
          # Get the image tags from metadata
          TAGS="${{ steps.meta.outputs.tags }}"

          # Create multi-arch manifests for each tag
          for TAG in $TAGS; do
            echo "Creating multi-arch manifest for $TAG"

            # For main branch and releases, create and push the actual manifest
            echo "Production mode: Creating and pushing multi-arch manifest"
            docker buildx imagetools create \
              --tag "$TAG" \
              "$TAG-amd64" \
              "$TAG-arm64"
            echo "✅ Multi-arch manifest created and pushed: $TAG"
          done

      - name: Validate loaded images (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "Validating PR images are properly loaded and functional"

          # Get the PR tags from metadata
          TAGS="${{ steps.meta.outputs.tags }}"

          for TAG in $TAGS; do
            echo "Checking images for tag: $TAG"

            # Verify both architecture images exist
            if docker image inspect "$TAG-amd64" >/dev/null 2>&1; then
              echo "✅ AMD64 image found: $TAG-amd64"
            else
              echo "❌ AMD64 image missing: $TAG-amd64"
              exit 1
            fi

            if docker image inspect "$TAG-arm64" >/dev/null 2>&1; then
              echo "✅ ARM64 image found: $TAG-arm64"
            else
              echo "❌ ARM64 image missing: $TAG-arm64"
              exit 1
            fi

            echo "✅ Both architecture images validated for $TAG"
          done

          echo "✅ All PR images validated successfully"

  # Build multi-service docker-compose for testing
  test-compose:
    name: Test Docker Compose
    runs-on: lf-large-amd64
    needs: [create-manifest]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download all image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-image'
          path: ${{ runner.temp }}/artifacts
          merge-multiple: true

      - name: Load all images from artifacts
        run: |
          echo "Loading all Docker images from artifacts..."
          for tar_file in ${{ runner.temp }}/artifacts/*.tar; do
            if [ -f "$tar_file" ]; then
              echo "Loading: $tar_file"
              docker load -i "$tar_file"
            fi
          done

          echo "Loaded images:"
          docker images

      - name: Tag images for docker-compose
        env:
          IMAGE_TAG: pr-${{ github.event.number }}
        run: |
          # Tag the loaded images with the expected format for docker-compose
          SERVICES=(designer server rag runtime)

          for SERVICE in "${SERVICES[@]}"; do
            # Find the loaded images for this service
            AMD64_IMAGE=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep "$SERVICE" | grep "amd64" | head -1 | tr -d ' ')

            if [ -n "$AMD64_IMAGE" ]; then
              # Tag for docker-compose (use AMD64 for testing)
              NEW_TAG="ghcr.io/${{ github.repository }}/${SERVICE}:${IMAGE_TAG}"
              echo "Tagging $AMD64_IMAGE -> $NEW_TAG"
              docker tag "$AMD64_IMAGE" "$NEW_TAG"
            else
              echo "Warning: No AMD64 image found for $SERVICE"
            fi
          done

          echo "Tagged images:"
          docker images | grep "pr-${{ github.event.number }}"

      - name: Prepare Docker environment
        run: |
          # Create base data directory for main llamafarm volume
          mkdir -p "$HOME/.llamafarm"
          chmod 777 "$HOME/.llamafarm" || true

          # ChromaDB now uses Docker-managed volumes, no directory creation needed

      - name: Test services startup
        working-directory: deployment/docker_compose
        env:
          IMAGE_TAG: pr-${{ github.event.number }}
        run: |
          # Start services and check they come up healthy
          docker compose -f docker-compose.yml up -d

          # Wait for services to be ready (ChromaDB needs more time to initialize)
          echo "Waiting for services to start..."
          sleep 60

          # Check ChromaDB server specifically
          echo "Checking ChromaDB server status..."
          docker compose -f docker-compose.yml logs chromadb-server | tail -20

          # Check if services are running
          docker compose -f docker-compose.yml ps

          # Basic health checks
          docker compose -f docker-compose.yml logs chromadb-server
          docker compose -f docker-compose.yml logs server
          docker compose -f docker-compose.yml logs designer
          docker compose -f docker-compose.yml logs rag

          # Test ChromaDB server connectivity
          echo "Testing ChromaDB server connectivity..."
          echo "Trying heartbeat endpoint..."
          curl -f http://localhost:8001/api/v2/heartbeat || echo "Heartbeat endpoint failed"

          echo "Trying version endpoint..."
          curl -f http://localhost:8001/api/v2/version || echo "Version endpoint failed"

          echo "Trying collections endpoint..."
          curl -f http://localhost:8001/api/v2/collections || echo "Collections endpoint failed"

      - name: Cleanup
        if: always()
        working-directory: deployment/docker_compose
        run: |
          docker compose -f docker-compose.yml down -v

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: create-manifest
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: read
      security-events: write
    strategy:
      matrix:
        service: [designer, server, rag, runtime]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: github.event_name != 'pull_request'
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
