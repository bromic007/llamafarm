name: Release - Docker images

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"

permissions:
  contents: read
  packages: read

jobs:
  tag-docker-images:
    name: Tag Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Wait for Docker images and tag them
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Determine the release tag
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.version }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "Release tag: ${TAG}"

          # Resolve commit SHA for the tag
          FULL_SHA=$(git rev-list -n 1 "${TAG}")
          SHORT_SHA=${FULL_SHA:0:7}
          echo "Full SHA: ${FULL_SHA} | Short SHA: ${SHORT_SHA}"

          # Login to GHCR
          echo "Logging in to GHCR"
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login "${REGISTRY}" -u "${{ github.actor }}" --password-stdin

          # Services to retag
          SERVICES=(designer server rag runtime)

          # Wait for all Docker images to be available
          echo "Waiting for Docker images to be built and pushed..."
          MAX_WAIT=1800  # 30 minutes max wait
          WAIT_INTERVAL=30  # Check every 30 seconds
          elapsed=0

          while [ $elapsed -lt $MAX_WAIT ]; do
            all_found=true

            for SERVICE in "${SERVICES[@]}"; do
              # Try both full and short SHA formats
              SRC1="${REGISTRY}/${IMAGE_NAME}/${SERVICE}:${TAG}-${FULL_SHA}"
              SRC2="${REGISTRY}/${IMAGE_NAME}/${SERVICE}:${TAG}-${SHORT_SHA}"

              echo "Checking for ${SERVICE} image..."
              if ! (docker manifest inspect "${SRC1}" >/dev/null 2>&1 || docker manifest inspect "${SRC2}" >/dev/null 2>&1); then
                echo "  ${SERVICE} image not ready yet"
                all_found=false
                break
              else
                echo "  ${SERVICE} image found"
              fi
            done

            if [ "$all_found" = true ]; then
              echo "All Docker images are available!"
              break
            fi

            echo "Waiting ${WAIT_INTERVAL} seconds before next check... (elapsed: ${elapsed}s)"
            sleep $WAIT_INTERVAL
            elapsed=$((elapsed + WAIT_INTERVAL))
          done

          if [ $elapsed -ge $MAX_WAIT ]; then
            echo "ERROR: Timeout waiting for Docker images to be available" >&2
            exit 1
          fi

          # Now retag the images
          echo "Retagging Docker images..."
          for SERVICE in "${SERVICES[@]}"; do
            SRC1="${REGISTRY}/${IMAGE_NAME}/${SERVICE}:${TAG}-${FULL_SHA}"
            SRC2="${REGISTRY}/${IMAGE_NAME}/${SERVICE}:${TAG}-${SHORT_SHA}"
            DST="${REGISTRY}/${IMAGE_NAME}/${SERVICE}:${TAG}"

            echo "Attempting to retag ${SERVICE} from ${SRC1} -> ${DST}"
            if docker pull "${SRC1}"; then
              docker tag "${SRC1}" "${DST}"
              docker push "${DST}"
              echo "Retagged ${SERVICE} using full SHA"
              continue
            fi

            echo "Full SHA tag not found, trying short SHA: ${SRC2}"
            if docker pull "${SRC2}"; then
              docker tag "${SRC2}" "${DST}"
              docker push "${DST}"
              echo "Retagged ${SERVICE} using short SHA"
              continue
            fi

            echo "ERROR: Could not find source image for ${SERVICE} with either ${SRC1} or ${SRC2}" >&2
            exit 1
          done

          echo "Docker images retagged for ${TAG}"
