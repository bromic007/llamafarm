name: End-to-End Tests
permissions:
  contents: read
  actions: read # Required to download artifacts from other workflows

on:
  # Trigger after CLI build completes (for main branch pushes)
  workflow_run:
    workflows: ["Build CLI"]
    types: [completed]
    branches: [main]
  # For PRs, trigger normally and wait for artifacts
  pull_request:
    branches: [main]
  # Also allow manual trigger
  workflow_dispatch:

env:
  NX_NO_CLOUD: true

jobs:
  e2e-test:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    # Skip e2e if CLI build failed (only for workflow_run trigger)
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: llamafarm-linux-amd64
            binary: lf
          - os: macos-latest
            artifact: llamafarm-darwin-arm64
            binary: lf
          # - os: windows-latest
          #   artifact: llamafarm-windows-amd64.exe
          #   binary: lf.exe
    env:
      # Use the current branch/ref being tested instead of main
      LF_VERSION_REF: ${{ github.head_ref || github.ref_name }}
      # Use CPU-only PyTorch to avoid downloading 3GB+ of CUDA packages in CI
      UV_EXTRA_INDEX_URL: https://download.pytorch.org/whl/cpu
      # Force CPU usage to avoid MPS issues on macOS runners
      TRANSFORMERS_FORCE_CPU: 1

    steps:
      # ============================================================
      # Setup Phase
      # ============================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered the build
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # ============================================================
      # Download Pre-built CLI Binary
      # ============================================================
      - name: Wait for CLI build artifacts (PRs only)
        if: github.event_name == 'pull_request'
        id: wait-artifacts
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for CLI build to produce artifacts..."
          COMMIT="${{ github.event.pull_request.head.sha }}"
          ARTIFACT_NAME="${{ matrix.artifact }}"
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "Checking for artifact (${ELAPSED}s elapsed)..."

            # Get artifact info including run ID
            ARTIFACT_INFO=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq ".artifacts[] | select(.name == \"${ARTIFACT_NAME}\") | select(.workflow_run.head_sha == \"${COMMIT}\") | {id: .id, run_id: .workflow_run.id}" \
              2>/dev/null | head -n 1)

            if [ -n "$ARTIFACT_INFO" ]; then
              ARTIFACT_ID=$(echo "$ARTIFACT_INFO" | jq -r '.id')
              RUN_ID=$(echo "$ARTIFACT_INFO" | jq -r '.run_id')
              echo "✓ Artifact found! (ID: ${ARTIFACT_ID}, Run: ${RUN_ID})"
              echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

          echo "❌ Timeout waiting for artifact after ${MAX_WAIT}s"
          exit 1

      - name: Download CLI binary artifact (with run_id)
        if: github.event.workflow_run.id || steps.wait-artifacts.outputs.run_id
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: cli.yml
          run_id: ${{ github.event.workflow_run.id || steps.wait-artifacts.outputs.run_id }}
          name: ${{ matrix.artifact }}
          path: cli/
          if_no_artifact_found: fail

      - name: Download CLI binary artifact (search by commit)
        if: ${{ !(github.event.workflow_run.id || steps.wait-artifacts.outputs.run_id) }}
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: cli.yml
          commit: ${{ github.sha }}
          name: ${{ matrix.artifact }}
          path: cli/
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Rename binary to standard name
        shell: bash
        run: |
          cd cli
          # The artifact contains the binary with the full artifact name
          # Rename it to the short name we want to use
          if [ -f "${{ matrix.artifact }}" ]; then
            mv "${{ matrix.artifact }}" "${{ matrix.binary }}"
            echo "✓ Renamed ${{ matrix.artifact }} to ${{ matrix.binary }}"
          else
            echo "Error: Downloaded artifact not found at cli/${{ matrix.artifact }}"
            ls -la
            exit 1
          fi

      - name: Make CLI binary executable
        if: runner.os != 'Windows'
        shell: bash
        run: chmod +x cli/${{ matrix.binary }}

      - name: Verify CLI binary works
        working-directory: cli
        shell: bash
        run: |
          ./${{ matrix.binary }} version
          echo "✓ CLI binary is functional"

      # ============================================================
      # Project Initialization
      # ============================================================
      - name: Create test directory
        shell: bash
        run: |
          TEST_DIR="${{ runner.temp }}/e2e-test"
          mkdir -p "$TEST_DIR"
          echo "TEST_DIR=$TEST_DIR" >> $GITHUB_ENV
          echo "✓ Test directory created at $TEST_DIR"

      - name: Initialize project with CLI
        working-directory: cli
        shell: bash
        run: |
          if ! ./${{ matrix.binary }} init --cwd "$TEST_DIR" --debug; then
            echo "❌ Project initialization failed, checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi
          echo "✓ Project initialized"

      - name: Verify project config was created
        shell: bash
        run: |
          if [ ! -f "$TEST_DIR/llamafarm.yaml" ]; then
            echo "❌ Error: llamafarm.yaml not created"
            exit 1
          fi
          echo "✓ Project configuration exists"
          echo ""
          echo "=== FULL CONFIG AFTER INIT ==="
          cat "$TEST_DIR/llamafarm.yaml"
          echo ""
          echo "=== Checking critical fields ==="
          echo "namespace: $(grep '^namespace:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "name: $(grep '^name:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "prompts.name: $(grep -A2 '^prompts:' "$TEST_DIR/llamafarm.yaml" | grep 'name:' | head -1 || echo 'MISSING')"

      # ============================================================
      # Data Ingestion Test
      # ============================================================
      - name: Create dataset
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          if ! ./${{ matrix.binary }} --cwd "$TEST_DIR" --debug datasets create \
            -s universal_processor \
            -b main_database \
            test_dataset; then
            echo "❌ Dataset creation failed, checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi
          echo "✓ Dataset created"

      - name: Wait for config sync after dataset create
        shell: bash
        run: sleep 2.5

      - name: Debug config after dataset create
        shell: bash
        run: |
          echo ""
          echo "=== Config after dataset create (first 40 lines) ==="
          head -40 "$TEST_DIR/llamafarm.yaml"
          echo ""
          echo "=== Checking critical fields ==="
          echo "namespace: $(grep '^namespace:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "name: $(grep '^name:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "prompts.name: $(grep -A2 '^prompts:' "$TEST_DIR/llamafarm.yaml" | grep 'name:' | head -1 || echo 'MISSING')"
          echo "datasets: $(grep -A5 '^datasets:' "$TEST_DIR/llamafarm.yaml" | head -6)"

      - name: Upload sample files
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          if ! ./${{ matrix.binary }} --cwd "$TEST_DIR" --debug datasets upload test_dataset "../examples/quick_rag/files"; then
            echo "❌ Upload failed for ../examples/quick_rag/files, checking server health..."
            echo "Current directory: $(pwd)"
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi
          echo "✓ All sample files uploaded"

      - name: Wait for config sync after dataset upload
        shell: bash
        run: sleep 2.5

      - name: Debug config before dataset process
        shell: bash
        run: |
          echo ""
          echo "=== Config before dataset process ==="
          echo "File exists: $(test -f "$TEST_DIR/llamafarm.yaml" && echo 'YES' || echo 'NO')"
          if [ -f "$TEST_DIR/llamafarm.yaml" ]; then
            echo "File size: $(wc -c < "$TEST_DIR/llamafarm.yaml")"
          else
            echo "File size: N/A"
          fi
          echo ""
          echo "=== Full config content ==="
          cat "$TEST_DIR/llamafarm.yaml" || echo "Failed to read config"
          echo ""
          echo "=== Critical fields check ==="
          echo "namespace: $(grep '^namespace:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "name: $(grep '^name:' "$TEST_DIR/llamafarm.yaml" || echo 'MISSING')"
          echo "prompts.name: $(grep -A2 '^prompts:' "$TEST_DIR/llamafarm.yaml" | grep 'name:' | head -1 || echo 'MISSING')"

      - name: Process dataset
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          sleep 2
          if ! ./${{ matrix.binary }} --cwd "$TEST_DIR" --debug datasets process test_dataset; then
            echo "❌ Dataset processing failed, checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi
          echo "✓ Dataset processing complete"

      # ============================================================
      # RAG Query Test
      # ============================================================
      - name: Run RAG query
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Running RAG query..."
          if ! OUTPUT=$(./${{ matrix.binary }} --cwd "$TEST_DIR" --debug rag query \
            --database main_database \
            --top-k 3 \
            "neural scaling laws" 2>&1); then
            echo "❌ RAG query command failed"
            echo "$OUTPUT"
            echo "Checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "$OUTPUT"

          # Verify output is not empty
          if [ -z "$OUTPUT" ]; then
            echo "❌ Error: RAG query returned empty output"
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "✓ RAG query returned results"

      - name: Validate RAG query results
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          if ! OUTPUT=$(./${{ matrix.binary }} --cwd "$TEST_DIR" --debug rag query \
            --database main_database \
            --top-k 3 \
            --include-metadata \
            "neural scaling laws" 2>&1); then
            echo "❌ RAG query validation failed"
            echo "$OUTPUT"
            echo "Checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          # Check if output contains expected content
          if echo "$OUTPUT" | grep -q "neural"; then
            echo "✓ RAG query results contain relevant content"
          else
            echo "⚠ Warning: Results may not contain expected content"
            echo "$OUTPUT"
          fi

      # ============================================================
      # Chat Command Test
      # ============================================================
      - name: Run chat command with RAG
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Running chat command with RAG..."
          if ! OUTPUT=$(./${{ matrix.binary }} --cwd "$TEST_DIR" --debug chat \
            "Summarize neural scaling laws in one sentence" 2>&1); then
            echo "❌ Chat command failed"
            echo "$OUTPUT"
            echo "Checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "Chat response:"
          echo "$OUTPUT"

          # Verify output is not empty
          if [ -z "$OUTPUT" ]; then
            echo "❌ Error: Chat command returned empty output"
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          # Check if output contains some text (at least 10 characters)
          if [ ${#OUTPUT} -lt 10 ]; then
            echo "❌ Error: Chat response too short, possible error"
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "✓ Chat command returned a response"

      - name: Test chat command without RAG
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Running chat command without RAG..."
          if ! OUTPUT=$(./${{ matrix.binary }} --cwd "$TEST_DIR" --debug chat \
            --no-rag \
            "What is 2 + 2?" 2>&1); then
            echo "❌ Chat command (no RAG) failed"
            echo "$OUTPUT"
            echo "Checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "Chat response:"
          echo "$OUTPUT"

          # Verify output is not empty
          if [ -z "$OUTPUT" ]; then
            echo "❌ Error: Chat command (no RAG) returned empty output"
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi

          echo "✓ Chat command without RAG works"

      # ============================================================
      # Validation & Summary
      # ============================================================
      - name: List datasets to verify persistence
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Listing datasets..."
          if ! ./${{ matrix.binary }} --cwd "$TEST_DIR" --debug datasets list; then
            echo "❌ Dataset listing failed, checking server health..."
            curl -s http://localhost:8000/health | jq '.' || echo "Server not reachable"
            exit 1
          fi
          echo "✓ Dataset listing works"

      - name: Check RAG health
        working-directory: cli
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Checking RAG health..."
          ./${{ matrix.binary }} --cwd "$TEST_DIR" --debug rag health || true
          echo "✓ RAG health check complete"

      - name: E2E test summary
        shell: bash
        run: |
          echo "=========================================="
          echo "End-to-End Test Summary (${{ matrix.os }})"
          echo "=========================================="
          echo "✓ CLI binary downloaded and verified"
          echo "✓ Project initialized"
          echo "✓ Dataset created and processed"
          echo "✓ RAG queries executed"
          echo "✓ Chat commands completed"
          echo "=========================================="
          echo "All E2E tests passed!"

      # ============================================================
      # Cleanup
      # ============================================================
      - name: Cleanup test artifacts
        if: always()
        shell: bash
        run: |
          echo "Cleaning up test directory..."
          rm -rf "$TEST_DIR"
          echo "✓ Cleanup complete"

      - name: Display service logs on failure
        if: failure()
        shell: bash
        run: |
          echo "=========================================="
          echo "Service Logs (${{ matrix.os }})"
          echo "=========================================="

          # Determine home directory (cross-platform)
          if [ "$RUNNER_OS" = "Windows" ]; then
            LF_HOME="$USERPROFILE/.llamafarm"
          else
            LF_HOME="$HOME/.llamafarm"
          fi

          # Display server logs if they exist
          if [ -f "$LF_HOME/logs/server.log" ]; then
            echo "--- Server Logs ---"
            tail -100 "$LF_HOME/logs/server.log"
          else
            echo "No server logs found at $LF_HOME/logs/server.log"
          fi

          echo ""

          # Display RAG logs if they exist
          if [ -f "$LF_HOME/logs/rag.log" ]; then
            echo "--- RAG Worker Logs ---"
            tail -100 "$LF_HOME/logs/rag.log"
          else
            echo "No RAG logs found at $LF_HOME/logs/rag.log"
          fi

          echo ""

          # Display Universal Runtime logs if they exist
          if [ -f "$LF_HOME/logs/universal-runtime.log" ]; then
            echo "--- Universal Runtime Logs ---"
            tail -100 "$LF_HOME/logs/universal-runtime.log"
          else
            echo "No Universal Runtime logs found at $LF_HOME/logs/universal-runtime.log"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ matrix.os }}
          path: ~/.llamafarm/logs/
          retention-days: 7
          if-no-files-found: warn
