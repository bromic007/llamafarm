name: Release - Desktop App

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., v0.0.1)"
        required: true
        default: "v0.0.1"

permissions:
  contents: write

env:
  NX_NO_CLOUD: true

jobs:
  build-macos:
    name: Build macOS Desktop App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION_NO_V="${VERSION#v}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION_NO_V}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION} (no v: ${VERSION_NO_V})"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: |
            designer/package-lock.json
            electron-app/package-lock.json

      - name: Install Designer dependencies
        working-directory: designer
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Build Designer
        working-directory: designer
        run: |
          npm run build
          # Verify build output
          if [ ! -f "dist/index.html" ]; then
            echo "Error: Designer build failed - dist/index.html not found" >&2
            exit 1
          fi
          echo "✅ Designer built successfully"

      - name: Install Electron app dependencies
        working-directory: electron-app
        run: npm ci || npm install

      - name: Update app version in package.json
        working-directory: electron-app
        run: |
          # Strip 'v' prefix from version
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          # Update version in package.json using Node.js
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION_NO_V';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "✅ Updated app version to $VERSION_NO_V"

      - name: Build and Sign Electron app
        working-directory: electron-app
        env:
          # Certificate (same as CLI workflow)
          CSC_LINK: ${{ secrets.APPLE_CERT_DATA }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          # Notarization via App Store Connect API (same as CLI workflow)
          APPLE_API_KEY: ${{ secrets.APPLE_NOTARY_KEY }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_NOTARY_ISSUER }}
        run: |
          # Remove identity: null from package.json to enable signing
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            delete pkg.build.mac.identity;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "Building and signing Electron app..."
          npm run dist:mac
          echo "✅ Electron app built and signed successfully"

      - name: Generate checksums
        working-directory: electron-app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          cd "release/${VERSION_NO_V}"

          # Generate SHA256 for all distributable files
          for file in *.dmg *.zip; do
            if [ -f "$file" ]; then
              shasum -a 256 "$file" > "$file.sha256"
              echo "✅ Generated checksum for $file"
              cat "$file.sha256"
            fi
          done

      - name: List build artifacts
        working-directory: electron-app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          echo "Build artifacts in release/${VERSION_NO_V}:"
          ls -lh "release/${VERSION_NO_V}/"

      - name: Verify build artifacts exist
        working-directory: electron-app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          echo "Checking for required artifacts in release/${VERSION_NO_V}/"

          # Check for required DMG files
          if ! ls "release/${VERSION_NO_V}"/*.dmg 1> /dev/null 2>&1; then
            echo "❌ ERROR: No DMG files found!"
            exit 1
          fi

          # Check for required ZIP files
          if ! ls "release/${VERSION_NO_V}"/*-mac.zip 1> /dev/null 2>&1; then
            echo "❌ ERROR: No ZIP files found!"
            exit 1
          fi

          echo "✅ All required artifacts found"
          ls -lh "release/${VERSION_NO_V}"/*.dmg "release/${VERSION_NO_V}"/*-mac.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: |
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*.dmg
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*.dmg.sha256
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*.dmg.blockmap
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*-mac.zip
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*-mac.zip.sha256
            electron-app/release/${{ steps.version.outputs.version_no_v }}/*-mac.zip.blockmap
          fail_on_unmatched_files: true
          append_body: true
          body: |

            ## Desktop App (macOS)

            Download the appropriate DMG for your Mac:
            - **Apple Silicon (M1/M2/M3)**: `LlamaFarm-${{ steps.version.outputs.version_no_v }}-arm64.dmg`
            - **Intel**: `LlamaFarm-${{ steps.version.outputs.version_no_v }}.dmg`

            ### Installation
            1. Download the DMG file
            2. Open the DMG and drag LlamaFarm to Applications
            3. Launch the app (it's signed and notarized, so it will open normally)
            4. The app will auto-install the CLI and start services

            ### Auto-Updates
            Once installed, the app will automatically check for updates and prompt you to install them.

            ### Code Signing
            This app is signed with an Apple Developer certificate and notarized by Apple for your security.

  test-installation:
    name: Test macOS App Installation
    needs: build-macos
    runs-on: macos-latest

    steps:
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION_NO_V="${VERSION#v}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION_NO_V}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION} (no v: ${VERSION_NO_V})"

      - name: Wait for release assets
        run: |
          echo "Waiting 60 seconds for release assets to be available..."
          sleep 60

      - name: Download and verify DMG (Apple Silicon)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          # Download the Apple Silicon DMG
          DMG_URL="https://github.com/llama-farm/llamafarm/releases/download/${VERSION}/LlamaFarm-${VERSION_NO_V}-arm64.dmg"
          echo "Downloading from: $DMG_URL"

          # Download with retries
          MAX_ATTEMPTS=3
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            if curl -L -f -o LlamaFarm.dmg "$DMG_URL"; then
              echo "✅ Download successful"
              break
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "⚠️  Download failed, retrying in 10 seconds..."
              sleep 10
            else
              echo "❌ ERROR: Failed to download DMG after $MAX_ATTEMPTS attempts"
              echo "The release may not have been published correctly."
              exit 1
            fi
          done

          # Verify the DMG exists and has content
          if [ ! -f "LlamaFarm.dmg" ]; then
            echo "❌ ERROR: DMG file not found after download"
            exit 1
          fi

          FILE_SIZE=$(stat -f%z "LlamaFarm.dmg")
          echo "✅ DMG downloaded successfully (${FILE_SIZE} bytes)"

          # Verify minimum file size (DMG should be at least 50MB)
          MIN_SIZE=$((50 * 1024 * 1024))
          if [ $FILE_SIZE -lt $MIN_SIZE ]; then
            echo "❌ ERROR: DMG file is too small (${FILE_SIZE} bytes < ${MIN_SIZE} bytes)"
            echo "The file may be corrupted or incomplete"
            exit 1
          fi

          # Mount the DMG to verify it's valid
          hdiutil attach LlamaFarm.dmg -mountpoint /Volumes/LlamaFarm || {
            echo "❌ ERROR: Failed to mount DMG"
            exit 1
          }

          # Check if the app exists
          if [ ! -d "/Volumes/LlamaFarm/LlamaFarm.app" ]; then
            echo "❌ ERROR: LlamaFarm.app not found in DMG"
            hdiutil detach /Volumes/LlamaFarm 2>/dev/null || true
            exit 1
          fi

          echo "✅ LlamaFarm.app found in DMG"

          # Verify app bundle structure
          if [ ! -f "/Volumes/LlamaFarm/LlamaFarm.app/Contents/MacOS/LlamaFarm" ]; then
            echo "❌ ERROR: App binary not found in bundle"
            hdiutil detach /Volumes/LlamaFarm
            exit 1
          fi

          echo "✅ App bundle structure is valid"

          # Unmount
          hdiutil detach /Volumes/LlamaFarm
          echo "✅ DMG verification complete - all checks passed"
